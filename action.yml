# action.yml
name: "Deploy Mautic to Selectel"
description: "Deploy Mautic with Docker Compose to a Selectel VPS with automated SSL and monitoring"
author: "MautiBox"

branding:
  icon: "cloud"
  color: "blue"

inputs:
  # --- Selectel configuration---
  selectel-token:
    description: "Selectel API access token (X-Token)"
    required: true
  ssh-private-key:
    description: "SSH private key for VPS access"
    required: true
  github-token:
    description: "GitHub Personal Access Token (PAT) for accessing private repositories for themes, plugins, and language packs."
    required: false

  # --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Mautic ---
  email:
    description: "Admin email address for Mautic and SSL certificates"
    required: true
  mautic-password:
    description: "Admin password for Mautic"
    required: true
  mautic-version:
    description: "Mautic Docker image version"
    required: false
    default: "6.0.5-apache"
  mautic-port:
    description: "Port for Mautic instance"
    required: false
    default: "8001"

  # --- –Ø–∑—ã–∫–æ–≤–æ–π –ø–∞–∫–µ—Ç Mautic ---
  language-pack-url:
    description: "URL to the language pack ZIP file (e.g., from a GitHub release)."
    required: false
    default: "https://github.com/zaharovrd/language-packs/raw/master/mautibox_ru.zip"
  locale:
    description: "The language code to set as default during installation (e.g., ru, es)."
    required: false
    default: "ru"
  default-timezone:
    description: "Default timezone for Mautic installation (e.g., Europe/Moscow)."
    required: false
    default: "Europe/Moscow"

  # --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VPS ---
  domain:
    description: "Domain name for your Mautic instance (optional, will use IP if not provided)"
    required: false
  vps-name:
    description: "Name for the Selectel scalet (server)"
    required: false
    default: "mautic-vps"
  vps-rplan:
    description: "Selectel server plan (e.g., small, medium, large)"
    required: false
    default: "medium"
  vps-location:
    description: "Selectel location (e.g., spb0, msk1)"
    required: false
    default: "spb0"

  # --- –ü–ª–∞–≥–∏–Ω—ã –∏ —Ç–µ–º—ã Mautic ---
  themes:
    description: |
      List of Mautic theme packages from Packagist or GitHub (one per line).

      Packagist packages:
      vendor/theme-name:^1.0
      another-vendor/custom-theme:dev-main

      GitHub URLs (public repositories):
      https://github.com/user/theme-repo/archive/refs/heads/main.zip

      GitHub URLs with custom directory and authentication:
      https://github.com/company/private-theme/archive/main.zip?directory=MyCustomTheme&token=ghp_xxxxxxxxxxxxxxxxxxxx
      https://github.com/vendor/premium-theme/archive/v2.1.0.zip?directory=PremiumTheme&token=ghp_yyyyyyyyyyyyyyyyyyyy
    required: false

  plugins:
    description: |
      List of Mautic plugin packages from Packagist or GitHub (one per line).

      Packagist packages:
      vendor/plugin-name:^2.0
      another-vendor/custom-plugin:^1.5

      GitHub URLs (public repositories):
      https://github.com/user/plugin-repo/archive/refs/heads/main.zip

      GitHub URLs with custom directory and authentication:
      https://github.com/company/private-plugin/archive/main.zip?directory=CompanyPlugin&token=ghp_xxxxxxxxxxxxxxxxxxxx
      https://github.com/vendor/premium-plugin/archive/v2.1.0.zip?directory=PremiumPlugin&token=ghp_yyyyyyyyyyyyyyyyyyyy

    required: false

  # --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö ---
  mysql-database:
    description: "MySQL database name"
    required: false
    default: "mautic_db"
  mysql-user:
    description: "MySQL user name"
    required: false
    default: "mautic_db_user"
  mysql-password:
    description: "MySQL password"
    required: true
  mysql-root-password:
    description: "MySQL root password"
    required: true

outputs:
  vps-ip:
    description: "IP address of the created VPS"
    value: ${{ steps.deploy.outputs.vps-ip }}
  mautic-url:
    description: "URL to access your Mautic instance"
    value: ${{ steps.deploy.outputs.mautic-url }}
  deployment-log:
    description: "Path to the deployment log artifact"
    value: ${{ steps.deploy.outputs.deployment-log }}

runs:
  using: "composite"
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        echo "üîç Validating required inputs..."
        if [ -z "${{ inputs.selectel-token }}" ]; then
          echo "‚ùå Error: selectel-token is required"
          exit 1
        fi
        if [ -z "${{ inputs.ssh-private-key }}" ]; then
          echo "‚ùå Error: ssh-private-key is required"
          exit 1
        fi
        if [ -z "${{ inputs.email }}" ]; then
          echo "‚ùå Error: email is required"
          exit 1
        fi
        if [ -z "${{ inputs.mautic-password }}" ]; then
          echo "‚ùå Error: mautic-password is required"
          exit 1
        fi
        if [ -z "${{ inputs.mysql-password }}" ]; then
          echo "‚ùå Error: mysql-password is required"
          exit 1
        fi
        if [ -z "${{ inputs.mysql-root-password }}" ]; then
          echo "‚ùå Error: mysql-root-password is required"
          exit 1
        fi
        echo "‚úÖ All required inputs validated"

    - name: Create and configure VPS on Selectel
      id: deploy
      shell: bash
      # –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è Selectel
      run: |
        echo "Debug URL from input: ${{ inputs.language-pack-url }}"
        ${{ github.action_path }}/scripts/deploy_selectel.sh
      env:
        # –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ inputs –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Å–∫—Ä–∏–ø—Ç
        INPUT_SELECTEL_TOKEN: ${{ inputs.selectel-token }}
        INPUT_SSH_PRIVATE_KEY: ${{ inputs.ssh-private-key }}
        INPUT_GITHUB_TOKEN: ${{ inputs.github-token }}
        INPUT_EMAIL: ${{ inputs.email }}
        INPUT_MAUTIC_PASSWORD: ${{ inputs.mautic-password }}
        INPUT_MAUTIC_VERSION: ${{ inputs.mautic-version }}
        INPUT_MAUTIC_PORT: ${{ inputs.mautic-port }}
        INPUT_LANGUAGE_PACK_URL: ${{ inputs.language-pack-url }}
        INPUT_LOCALE: ${{ inputs.locale }}
        INPUT_DOMAIN: ${{ inputs.domain }}
        INPUT_VPS_NAME: ${{ inputs.vps-name }}
        INPUT_VPS_RPLAN: ${{ inputs.vps-rplan }}
        INPUT_VPS_LOCATION: ${{ inputs.vps-location }}
        INPUT_THEMES: ${{ inputs.themes }}
        INPUT_PLUGINS: ${{ inputs.plugins }}
        INPUT_MYSQL_DATABASE: ${{ inputs.mysql-database }}
        INPUT_MYSQL_USER: ${{ inputs.mysql-user }}
        INPUT_MYSQL_PASSWORD: ${{ inputs.mysql-password }}
        INPUT_MYSQL_ROOT_PASSWORD: ${{ inputs.mysql-root-password }}
        ACTION_PATH: ${{ github.action_path }}

    - name: Upload deployment log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mautic-deployment-log
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –∫ –ª–æ–≥—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        path: ./setup-dc.log

    - name: Cleanup
      shell: bash
      if: always()
      run: |
        echo "üßπ Cleaning up SSH keys and temporary files..."
        rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
        echo "‚úÖ Cleanup completed"
