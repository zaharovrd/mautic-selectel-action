# templates/docker-compose.yml
version: '3.8'

x-mautibox-volumes: &mautibox-volumes
  - mautibox_config:/var/www/html/config
  - mautibox_plugins:/var/www/html/docroot/plugins
  - mautibox_themes:/var/www/html/docroot/themes
  - mautibox_media:/var/www/html/docroot/media
  - mautibox_translations:/var/www/html/docroot/translations
  - ./logs:/var/www/html/var/logs

services:
  mautibox_db:
    image: mariadb:10.11
    container_name: mautibox_db
    env_file:
      - .mautic_env
    volumes:
      - db_data:/var/lib/mysql
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: [ "CMD", "mariadb-admin", "ping", "-h", "localhost", "--silent" ]
      start_period: 60s
      interval: 30s
      timeout: 15s
      retries: 8
    networks:
      - mautibox_net

  mautibox_web:
    image: mautic/mautic:${MAUTIC_VERSION}
    container_name: mautibox_web
    depends_on:
      mautibox_db:
        condition: service_healthy
    ports:
      - "${PORT:-8001}:80"
    env_file:
      - .mautic_env
    environment:
      - DOCKER_MAUTIC_ROLE=mautic_web
      - DOCKER_MAUTIC_LOAD_TEST_DATA=false
      - DOCKER_MAUTIC_RUN_MIGRATIONS=true
      # PHP timeout settings for SMTP configuration and long-running operations
      - PHP_MAX_EXECUTION_TIME=300
      - PHP_MAX_INPUT_TIME=300
      - PHP_MEMORY_LIMIT=512M
    volumes: *mautibox-volumes
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - mautibox_net

  # Mautic cron jobs
  mautibox_cron:
    image: mautic/mautic:${MAUTIC_VERSION}
    container_name: mautibox_cron
    depends_on:
      mautibox_web:
        condition: service_healthy
    env_file:
      - .mautic_env
    environment:
      - DOCKER_MAUTIC_ROLE=mautic_cron
    volumes: *mautibox-volumes
    restart: unless-stopped
    networks:
      - mautibox_net

  # Mautic worker for background processing (disabled by default during initial deployment)
  mautibox_worker:
    image: mautic/mautic:${MAUTIC_VERSION}
    container_name: mautibox_worker
    depends_on:
      mautibox_web:
        condition: service_healthy
    env_file:
      - .mautic_env
    environment:
      - DOCKER_MAUTIC_ROLE=mautic_worker
    volumes: *mautibox-volumes
    command: php /var/www/html/bin/console messenger:consume email async priority normal --limit=10 --memory-limit=512M
    restart: unless-stopped
    profiles:
      - worker # This allows us to start worker separately after installation
    networks:
      - mautibox_net

volumes:
  mautibox_config:
  mautibox_plugins:
  mautibox_themes:
  mautibox_media:
  mautibox_translations:
  db_data:


networks:
  mautibox_net:
    driver: bridge
